pipeline {
    agent any
    
    environment {
        APP_NAME = "fastapi-app"
        IMAGE_TAG = "v${BUILD_NUMBER}"
        NAMESPACE = "devops-tools"
        SERVICE_PORT = "32100"
        DOCKER_IMAGE = "${APP_NAME}:${IMAGE_TAG}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "========================================="
                echo "ğŸ”„ Checking out code from GitHub"
                echo "Repository: ${env.GIT_URL}"
                echo "Branch: ${env.GIT_BRANCH}"
                echo "========================================="
                checkout scm
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo "ğŸ³ Building Docker image: ${DOCKER_IMAGE}"
                    sh """
                        cd cicd
                        docker build -t ${DOCKER_IMAGE} -f Dockerfile ..
                        docker tag ${DOCKER_IMAGE} ${APP_NAME}:latest
                    """
                    echo "âœ… Docker image built successfully"
                    sh "docker images | grep ${APP_NAME}"
                }
            }
        }
        
        stage('Test Docker Image') {
            steps {
                script {
                    echo "ğŸ§ª Testing Docker image..."
                    sh """
                        # ì„ì‹œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                        docker run -d --name test-container -p 8888:8000 ${DOCKER_IMAGE}
                        
                        # ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                        sleep 5
                        
                        # Health check
                        curl -f http://localhost:8888/health || exit 1
                        
                        # API í…ŒìŠ¤íŠ¸
                        curl -f http://localhost:8888/api/test || exit 1
                        
                        # ì»¨í…Œì´ë„ˆ ì •ë¦¬
                        docker stop test-container
                        docker rm test-container
                    """
                    echo "âœ… Docker image test passed"
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo "â˜¸ï¸  Deploying to Kubernetes..."
                    sh """
                        # Deployment YAML ìˆ˜ì • (placeholder ì¹˜í™˜)
                        sed -e 's|IMAGE_NAME_PLACEHOLDER|${DOCKER_IMAGE}|g' \
                            -e 's|IMAGE_TAG_PLACEHOLDER|${IMAGE_TAG}|g' \
                            -e 's|VERSION_PLACEHOLDER|${IMAGE_TAG}|g' \
                            -e 's|BUILD_PLACEHOLDER|${BUILD_NUMBER}|g' \
                            cicd/k8s-deployment.yaml | kubectl apply -f -
                    """
                    echo "âœ… Kubernetes deployment applied"
                }
            }
        }
        
        stage('Wait for Rollout') {
            steps {
                script {
                    echo "â³ Waiting for deployment to complete..."
                    sh """
                        kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --timeout=120s
                    """
                    echo "âœ… Rollout completed successfully"
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo "ğŸ” Verifying deployment..."
                    sh """
                        echo "\n========== Deployment Info =========="
                        kubectl get deployment ${APP_NAME} -n ${NAMESPACE} -o wide
                        
                        echo "\n========== Pods =========="
                        kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME} -o wide
                        
                        echo "\n========== Service =========="
                        kubectl get svc ${APP_NAME}-service -n ${NAMESPACE}
                        
                        echo "\n========== Endpoints =========="
                        kubectl get endpoints ${APP_NAME}-service -n ${NAMESPACE}
                    """
                }
            }
        }
        
        stage('API Health Check') {
            steps {
                script {
                    echo "ğŸ¥ Running API health checks..."
                    sh """
                        sleep 5
                        
                        echo "\n========== Health Check =========="
                        curl -s http://localhost:${SERVICE_PORT}/health | python3 -m json.tool
                        
                        echo "\n========== API Info =========="
                        curl -s http://localhost:${SERVICE_PORT}/api/info | python3 -m json.tool
                        
                        echo "\n========== API Test =========="
                        curl -s http://localhost:${SERVICE_PORT}/api/test | python3 -m json.tool
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âœ… DEPLOYMENT SUCCESSFUL! âœ…                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Application: ${APP_NAME}
â•‘  Version: ${IMAGE_TAG}
â•‘  Build: #${BUILD_NUMBER}
â•‘  
â•‘  ğŸŒ Access URLs:
â•‘     Main:   http://localhost:${SERVICE_PORT}/
â•‘     Health: http://localhost:${SERVICE_PORT}/health
â•‘     Info:   http://localhost:${SERVICE_PORT}/api/info
â•‘     Test:   http://localhost:${SERVICE_PORT}/api/test
â•‘     Docs:   http://localhost:${SERVICE_PORT}/docs
â•‘  
â•‘  ğŸ“Š Kubernetes:
â•‘     kubectl get all -n ${NAMESPACE} -l app=${APP_NAME}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        failure {
            echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                âŒ DEPLOYMENT FAILED! âŒ                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Build: #${BUILD_NUMBER}
â•‘  
â•‘  ğŸ” Check logs:
â•‘     kubectl logs -n ${NAMESPACE} -l app=${APP_NAME}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        always {
            echo "ğŸ§¹ Cleaning up test containers..."
            sh """
                docker ps -a | grep test-container | awk '{print \$1}' | xargs -r docker rm -f || true
            """
        }
    }
}