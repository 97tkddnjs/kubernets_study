pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
    app: fastapi-builder
spec:
  serviceAccountName: jenkins-admin
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest
    args:
    - \$(JENKINS_SECRET)
    - \$(JENKINS_NAME)
  
  - name: docker
    image: docker:24
    command:
    - cat
    tty: true
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run/docker.sock
  
  - name: kubectl
    image: alpine/k8s:1.28.3
    command:
    - cat
    tty: true
  
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
'''
            defaultContainer 'jnlp'
        }
    }
    
    environment {
        APP_NAME = "fastapi-app"
        IMAGE_TAG = "v${BUILD_NUMBER}"
        NAMESPACE = "devops-tools"
        SERVICE_PORT = "32100"
        DOCKER_IMAGE = "${APP_NAME}:${IMAGE_TAG}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "ğŸ”„ Checkout"
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                container('docker') {
                    echo "ğŸ³ Building: ${DOCKER_IMAGE}"
                    sh """
                        cd kube-jenkins-deploy
                        docker build -t ${DOCKER_IMAGE} -f cicd/Dockerfile .
                        docker tag ${DOCKER_IMAGE} ${APP_NAME}:latest
                    """
                }
            }
        }
        
        stage('Deploy') {
            steps {
                container('kubectl') {
                    sh """
                        set -ex
                        
                        cd kube-jenkins-deploy
                        
                        echo "Creating deployment YAML..."
                        sed -e 's|IMAGE_NAME_PLACEHOLDER|${DOCKER_IMAGE}|g' \
                            -e 's|IMAGE_TAG_PLACEHOLDER|${IMAGE_TAG}|g' \
                            -e 's|VERSION_PLACEHOLDER|${IMAGE_TAG}|g' \
                            -e 's|BUILD_PLACEHOLDER|${BUILD_NUMBER}|g' \
                            cicd/deployment.yaml | tee /tmp/deployment.yaml
                        
                        echo "Applying..."
                        kubectl apply -f /tmp/deployment.yaml
                        
                        echo "Done!"
                    """
                }
            }
        }
        
        stage('Wait') {
            steps {
                container('kubectl') {
                    sh "kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --timeout=120s"
                }
            }
        }
        
        stage('Verify') {
            steps {
                container('kubectl') {
                    sh """
                        kubectl get deployment ${APP_NAME} -n ${NAMESPACE}
                        kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME}
                        kubectl get svc ${APP_NAME}-service -n ${NAMESPACE}
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     âœ… SUCCESS! âœ…                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ${APP_NAME}:${IMAGE_TAG}
â•‘  ğŸŒ http://localhost:${SERVICE_PORT}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        failure {
            echo "âŒ FAILED"
        }
    }
}